---
title: "Playing Style"
author: "Braden Churcher"
date: "27 June 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load("~/Documents/UNI/Winter Research Project/Data/atp_serves.RData")

library(ggplot2)
library(dplyr)
<<<<<<< HEAD
library(purrr)
=======

load("atp_serves.RData")
>>>>>>> master

g <- function(coef, t) coef %*% t^(0:3)
g(unlist(atp_serves[1,c("raw.x0.1","raw.x1.1","raw.x2.1","raw.x3.1")]),atp_serves$start.1[1])

fedvmurray <- atp_serves[atp_serves$matchid=="AO2016F_Djokovic_Murray",]

table(atp_serves$server)
table(atp_serves$receiver)




```

## R Markdown
*Brain storm of serve styles*
List of Serve Characteristics for feature selection:
1st vs 2nd Serve
Points in game? if reciever is on 40 or server is on 40. Does this differ? are there risk takers?
Winning serves
Receivers Hand (R/L)
Riskiness and 
Types and key points:
Kick Serve:
  - Height of bounce (Z at )
      - Where was the Ball received?
  - Height over the net
  - Location ball is struck (is this different? To get top spin is it in a different spot)
  - Second serve characteristics
  - Speed
  - Spin? 
    - squared coefficients c2 --generate points function
    - How do we calculate this?
  - Location in Service Box

Down the tee (Flat vs Spin/Kick)
  - Ball location in service box, depth looks important
  - Speed
  - Location ball is hit. For right handers in the ad court this could be back past the centre line on the      deuce side
Outwide (Flat vs Spin/Kick)

Variables needed for Clustering:
Player - Server
X, Z, Y From start to finish.
Coefficients 
Speed
Receiver
Volicity 
Serve
Serve classification


** Random Plots ***  
## Roger Federer Receiving ##
```{r}

fedr <- atp_serves %>% filter(receiver == "FEDERER")
ggplot(fedr, aes(x=center.x, y=center.y, color=factor(serve_classification))) + geom_point() + facet_wrap(~side)
<<<<<<< HEAD
```
## Serve location by player ##
```{r}
ggplot(atp_serves_sub, aes(x=start.y, y=start.z, color=factor(server))) + geom_point()
```
=======

>>>>>>> master
## Most Aces ##

```{r}
table(atp_serves$server, atp_serves$serve_classification== "0")
```
## Raonic Aces ##
``` {r}
Rao<- atp_serves %>% filter(server == "RAONIC")
ggplot(Rao, aes(x=start.y, y=start.z, color=factor(serve_classification == "0"))) + geom_point()
ggplot(Rao, aes(x=start.x, y=start.z, color=factor(serve_classification == "0"))) + geom_point() 
ggplot(Rao, aes(x=center.x, y=center.y, color=factor(serve_classification))) + geom_point() 
```

``` {r}
# Net Clearance Height by 1st and second serve #
#work out how to solve for x in arc one at x=0 for all serves#
ggplot(atp_serves, aes(x=center.x, y=net.clearance, color=factor(serve.x))) + geom_point() 
ggplot(atp_serves, aes(x=center.y, y=net.clearance, color=factor(serve.x))) + geom_point() 
```
Using the distance at which the ball bounced in the x direction, you can see the difference in serves. The first serve being clearly longer and slightly lower over the net. 
Using the width at which the ball bounced in the court you can see the how second serves are generally much safer. The height over the net though may not be exactly easy to determine if it is different, there does seem to be less serves at the lower end of the scale and more variation in the second serve. 
Interestingly you can see how the net slouches in the the middle of the court. 

```{r}
# Different points in games #
ggplot(atp_serves, aes(x=center.x, y=center.y, color=factor(serve.x))) + geom_point() + facet_wrap(~receiver_score)

```


```{r}
## Roger Federer Receiving ##
fedr <- atp_serves %>% filter(receiver == "FEDERER")
ggplot(fedr, aes(x=center.x, y=center.y, color=factor(serve_classification))) + geom_point() + facet_wrap(~side)

## Most Aces ##
table(atp_serves$server, atp_serves$serve_classification== "0")

## Raonic Aces ##
Rao<- atp_serves %>% filter(server == "RAONIC")
ggplot(Rao, aes(x=start.y, y=start.z, color=factor(serve_classification == "0"))) + geom_point()
```


You can also embed plots, for example:

```{r pressure, echo=FALSE}
### Mitchell code for Court Position of Ball ###
traj_coords <- function(start, dir, flip, c0, c1, c2, c3, tm=0) {
  tm <- tm + start
  if (dir != "z") {
    c0 <- flip * c0
    c1 <- flip * c1
    c2 <- flip * c2
    c3 <- flip * c3
  }
  pos <- c0 + c1*tm + c2*tm^2 + c3*tm^3
  return(pos)
}

GeneratePoints <- function(data, ..., arc1=10, arc3=0, plot=FALSE){
  require(tidyr)
  require(dplyr)
  require(purrr)
  
  #arc2*(start.3 - (start.1+duration.arc1))
  data <- data %>% mutate(duration = arc1*duration.arc1 + arc3*duration.arc3, flip=sign(raw.x0.1))
  
  dots <- c("serveid", sapply(substitute(list(...))[-1], deparse))
  extravars <- match(dots[dots%in%colnames(data)], colnames(data))
  
  out <- data.frame()
  
  if(arc1!=0){
    arc1p <- data %>% select(extravars, start.1, duration.arc1, flip, raw.x0.1:raw.z3.1) %>%
      gather(coef, value, -(1:length(extravars)), -start.1, -duration.arc1, -flip) %>%
      separate(coef, c("junk1", "coef", "junk2"), sep="\\.") %>%
      select(-junk1, -junk2) %>%
      mutate(dir=substr(coef, 1, 1), coef=substr(coef, 2, 2)) %>%
      spread(coef, value) %>%
      rename("start" = `start.1`, "duration"=`duration.arc1`, "c0"=`0`, "c1"=`1`, "c2"=`2`, "c3"=`3`)
      arc1points <- seq(0,1,length.out=arc1) %>%
        map_df(function(x) mutate(rowwise(arc1p), time=start+duration*x, pos=traj_coords(start, dir, flip, c0, c1, c2, c3, tm=duration*x)))
      out <- rbind(out, cbind(arc=1, arc1points))
  }
  
  if(arc3!=0){
    arc3p <- data %>% select(extravars, start.3, duration.arc3, flip, raw.x0.3:raw.z3.3) %>%
      gather(coef, value, -(1:length(extravars)), -start.3, -duration.arc3, -flip) %>%
      separate(coef, c("junk1", "coef", "junk2"), sep="\\.") %>%
      select(-junk1, -junk2) %>%
      mutate(dir=substr(coef, 1, 1), coef=substr(coef, 2, 2)) %>%
      spread(coef, value) %>%
      rename("start" = `start.3`, "duration"=`duration.arc3`, "c0"=`0`, "c1"=`1`, "c2"=`2`, "c3"=`3`)
    arc3points <- seq(0,1, length.out=arc3) %>%
      map_df(function(x) mutate(rowwise(arc3p), time=start+duration*x, pos=traj_coords(start, dir, flip, c0, c1, c2, c3, tm=duration*x)))
    out <- rbind(out, cbind(arc=3, arc3points))
  }
  
  if(plot){
    extravars <- match(dots[dots%in%colnames(out)], colnames(out))
    out <- out %>% select(arc, extravars, flip, dir, time, pos) %>%
      spread(dir, pos)
  }
  
  return(out)
}

#DEMO
### Court Trace ###
courtTrace <- data.frame(x = c(-11.89, -11.89, 0, 0, 0, 0, 0, 0, 11.89, 11.89, -11.89, -11.89, 11.89, 11.89, -11.89, -6.4, -6.4, 6.4, 6.4, 6.4, -6.4),
                         y = c(5.49, -5.49, -5.49, -6.5, -6.5, 6.5, 6.5, -5.49, -5.49, 5.49, 5.49, 4.115, 4.115, -4.115, -4.115, -4.115, 4.115, 4.115, -4.115, 0, 0),
                         z = c(0, 0, 0, 0, 1.09, 1.09, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0))

#DEMO
sample <- GeneratePoints(atp_serves[1:10,], server, arc3=10,plot=TRUE)

ggplot() + geom_path(data = courtTrace, aes(x = x, y = y), color = 'black', size = 0.5) +
  geom_segment(aes(x= 0, xend= 0, y= -6.5, yend= 6.5), size = 0.5, color = 'darkgrey', lineend = 'round') +
  geom_line(aes(x=x,y=y, group=serveid), data=sample)

ggplot() + geom_segment(aes(x=-11.89, xend=11.89, y=0, yend=0), size=0.5) + 
  geom_segment(aes(x=0,xend=0,y=0,yend=1.07), color='darkgrey') + 
  geom_line(aes(x=x, y=z, group=serveid, colour=time), data=sample)



library(plotly)
plot_ly(sample, x=x, y=y, z=z, group=serveid, type="scatter3d", mode="lines") %>%
  add_trace(x=x, y=y, z=z, data=courtTrace, type="scatter3d", mode="lines") %>%
  layout(scene=list(aspectmode="data"))


library(dplyr)
library(purrr)

```

### What Variables should be used for Cluster Analysis? ###

``` {r}
## Practice Cluster ##
# Cluster Second Coefficients #
test<- cbind(cluster=kmeans(atp_serves[,c("raw.x2.1", "raw.y2.1")], centers=2)$cluster, atp_serves)
ggplot(test, aes(x=raw.x2.1, y=raw.y2.1, colour=cluster)) + geom_point() + facet_wrap(~side)
ggplot(atp_serves, aes(x=x2.1, y=y2.1)) + geom_point() + facet_wrap(~side)
# note: Coefficents looked to be flipped. Does not seem to give anything usefullooking at these coefficients. 

```
# Creating Sample for Hierarchical Cluster Analysis #
First cluster analysis will just look at using a few different variables. Due to the differences in right handers serving to Ad and Deuce courts, the sample is split by the variable side to see what clusters are present on each side of the court (Ad=943, Deuce = 1057). These results will be compared later to see if the side of the court effects and gives rise to different clusters. 


```{r}
## First attempt ugly## 

## Cluster analysis on Ad Court side ##
adcourtclust<- atp_serves %>% filter(side=="Ad") %>% select(server, center.x, center.y, serve_classification, serve.x, start.x, start.y, start.z, net.clearance) 
adcourtclust$serve_classification<- factor(adcourtclust$serve_classification)
adcourtclust$serve.x<- factor(adcourtclust$serve.x)

clusters <- hclust(dist(adcourtclust[, 2:9]))
plot(clusters)
clustercut<- cutree(clusters,5)
adcourtclust$clust5<-clustercut
ggplot(adcourtclust, aes(x=center.x, y=center.y, color=factor(clust5))) + geom_point()

adcourtclustplot<- atp_serves %>% filter(side=="Ad") 
adcourtclustplot$clust5 <- clustercut
sampleclust5plot <- GeneratePoints(adcourtclustplot, clust5, server, arc3=10,plot=TRUE)
ggplot() + geom_path(data = courtTrace, aes(x = x, y = y), color= 'Black', size = 0.5) +
  geom_segment(aes(x= 0, xend= 0, y= -6.5, yend= 6.5), size = 0.5, color = 'darkgrey', lineend = 'round') +
  geom_line(aes(x=x,y=y, group=serveid, color=factor(clust5)), data=sampleclust5plot) 


## Deuce Court ##

deucecourtclust<- atp_serves %>% filter(side=="Deuce") %>% select(server, center.x, center.y, serve_classification, serve.x, start.x, start.y, start.z, net.clearance) 
deucecourtclust$serve_classification<- factor(deucecourtclust$serve_classification)
deucecourtclust$serve.x<- factor(deucecourtclust$serve.x)

clusters2 <- hclust(dist(deucecourtclust[, 2:9]))
plot(clusters2)
clustercut2<- cutree(clusters2,4)
deucecourtclust$clust4<-clustercut2
ggplot(deucecourtclust, aes(x=center.x, y=center.y, color=factor(clust4))) + geom_point()

deucecourtclustplot<- atp_serves %>% filter(side=="Deuce") 
deucecourtclustplot$clust4 <- clustercut2
deucesampleclust4plot <- GeneratePoints(deucecourtclustplot, clust4, server, arc3=10,plot=TRUE)
ggplot() + geom_path(data = courtTrace, aes(x = x, y = y), color= 'Black', size = 0.5) +
  geom_segment(aes(x= 0, xend= 0, y= -6.5, yend= 6.5), size = 0.5, color = 'darkgrey', lineend = 'round') +
  geom_line(aes(x=x,y=y, group=serveid, color=factor(clust4)), data=deucesampleclust4plot) 

```


```{r}

## Basic Hierarchical Cluster Using Given Variables ##
# Note using first serve only #
courtclust<- atp_serves %>% filter(serve.x=="1") %>% select(server, center.x, center.y, speed, start.x, start.y, start.z, net.clearance, height_off_bounce, angle.change, side) %>% mutate_each(funs(scale), 2:10)
courtclust$side<- factor(courtclust$side)



clusters <- hclust(dist(courtclust[, 2:10]))
plot(clusters)
clustercut<- cutree(clusters,9)
courtclust$clust5<-clustercut
ggplot(courtclust, aes(x=center.x, y=center.y, color=factor(clust5))) + geom_point() + facet_grid(~side)

```

For given serves working out comparable points is important. For simplicity on each polynomial we have decided to work out the y and z value at both service boxes (x= -6.4, +6.4) and the net(x=0)


```{r}
### Feature Generation Testing ###
# Height of bounce # 
summary(atp_serves$height_off_bounce)
hist(atp_serves$height_off_bounce)

# Direction Change #
# Plotting the the serves with changes in direction #
changedirection<- atp_serves %>% filter(direction.change == "TRUE")
sample <- GeneratePoints(changedirection, server, side, server.x, serve_classification, arc3=10,plot=TRUE)

ggplot() + geom_path(data = courtTrace, aes(x = x, y = y), color = 'black', size = 0.5) +
  geom_segment(aes(x= 0, xend= 0, y= -6.5, yend= 6.5), size = 0.5, color = 'darkgrey', lineend = 'round') +
  geom_line(aes(x=x,y=y, group=serveid), data=sample)

ggplot() + geom_segment(aes(x=-11.89, xend=11.89, y=0, yend=0), size=0.5) + 
  geom_segment(aes(x=0,xend=0,y=0,yend=1.07), color='darkgrey') + 
  geom_line(aes(x=x, y=z, group=serveid, colour=time), data=sample)



library(plotly)
plot_ly(sample, x=x, y=y, z=z, group=serveid, type="scatter3d", mode="lines") %>%
  add_trace(x=x, y=y, z=z, data=courtTrace, type="scatter3d", mode="lines") %>%
  layout(scene=list(aspectmode="data"))
summary(atp_serves$direction.change)




```
** Theory on different types of serves **
http://www.tennis4you.com/lesson-lounge/tennis4you/serve/4-different-serves.htm
https://www.coachup.com/resources/tennis/tennis-different-serving-methods?utm_campaign=client_organic&utm_content=Tennis_resource_DIFFERENT_TYPES_OF_TENNIS_SERVES&utm_medium=Active&utm_source=PR

4 types of Serves
Flat Serve
Slice Serve
Top-Spin Serve
Kick Serve


```



